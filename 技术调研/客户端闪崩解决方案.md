# 			客户端崩溃排查与解决方案

我们常常在开发中，总会遇到下面这种情况，app在后台突然崩溃，甚至于app启动时直接闪退，如果是在开发中，发现这种问题，我们不难通过崩溃日志，定位问题原因，但如果是线上客户使用发现问题，往往一般很难排查，对于这种情况，我们一般通过如下方案解决。



## 

**Thread.UncaughtExceptionHandler**

> 线程未捕获异常处理器，用于处理未捕获的异常，如果程序出现了未捕获的异常，默认会弹出系统中强制关闭的对话框，一般情况下，我们可以实现此接口，并注册为程序中默认的未捕获异常处理，这样以便于我们做一些相应的处理工作。

```kotlin
class CrashExceptionHandler : Thread.UncaughtExceptionHandler {

    private var mDefaultHandler: Thread.UncaughtExceptionHandler? = null

    override fun uncaughtException(p0: Thread, p1: Throwable) {
        //处理异常，一堆自定义操作
      
      	//调用其他的异常处理工具
        mDefaultHandler?.uncaughtException(p0, p1)
    }

    companion object {
        private val crashExceptionHandler by lazy {
            CrashExceptionHandler()
        }

        @JvmStatic
        fun getInstance(): CrashExceptionHandler {
            return crashExceptionHandler
        }

    }

    fun init() {
        if (Thread.getDefaultUncaughtExceptionHandler() != this) {
          	//获取系统默认的异常处理工具
            mDefaultHandler = Thread.getDefaultUncaughtExceptionHandler()
            Thread.setDefaultUncaughtExceptionHandler(this)
        }
    }
}
```

```kotlin
class AssApplication : Application() {
    override fun onCreate() {
        super.onCreate()
        CrashExceptionHandler.instance()
        CrashReport.initCrashReport(applicationContext, "0d302b0082", true)
    }
}
```

这种方式虽然简单直接，但是相应的异常处理，记录，上传都比较麻烦，所以我们一般会使用第三方sdk去实现上述操作。如bugly,网易云捕，友盟，其中网易云捕目前是收费的，友盟的异常监控必须等待app再次启动时才能上传，所以推荐使用bugly去作为异常检测工具。



## 2.使用第三方sdk检测异常

### 使用bugly检测异常

bugly是腾讯推出的一个免费的异常上报和运营统计工具，目的是帮助移动开发者快速发现并解决问题,[文档地址。](https://bugly.qq.com/docs/)

### Bugly-Android集成方式

#### 集成SDK和 NDK

```groovy
android {
    defaultConfig {
        ndk {
            // 设置支持的SO库架构
            abiFilters 'armeabi' //, 'x86', 'armeabi-v7a', 'x86_64', 'arm64-v8a'
        }
    }
}

dependencies {
    implementation 'com.tencent.bugly:crashreport:latest.release' 
    //其中latest.release指代最新Bugly SDK版本号，也可以指定明确的版本号，例如2.1.9
    implementation 'com.tencent.bugly:nativecrashreport:latest.release' 
    //其中latest.release指代最新Bugly NDK版本号，也可以指定明确的版本号，例如3.0
}
```

> ```
> 注意：自动集成时会自动包含Bugly SO库，建议在Module的build.gradle文件中使用NDK的“abiFilter”配置，设置支持的SO库架构。
> ```
>
> 如果在添加**“abiFilter”**之后Android Studio出现以下提示：
>
> ```
> NDK integration is deprecated in the current plugin.  Consider trying the new experimental plugin.
> ```
>
> 则在项目根目录的**gradle.properties**文件中添加：
>
> ```java
> android.useDeprecatedNdk=true
> ```

#### 参数配置

在AndroidManifest.xml中添加权限

```java
<uses-permission android:name="android.permission.READ_PHONE_STATE" />
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
<uses-permission android:name="android.permission.READ_LOGS" />
```

#### 混淆配置

```xml
-dontwarn com.tencent.bugly.**
-keep public class com.tencent.bugly.**{*;}
```



#### 初始化

```kotlin
CrashReport.initCrashReport(getApplicationContext(), "注册时申请的APPID", false)
```

##### **注意：**

*为了保证运营数据的准确性，建议不要在异步线程初始化Bugly。*

> 第三个参数为SDK调试模式开关，调试模式的行为特性如下：
>
> - 输出详细的Bugly SDK的Log；
> - 每一条Crash都会被立即上报；
> - 自定义日志将会在Logcat中输出。
>
> 建议在测试阶段建议设置成true，发布时设置为false。



#### MultiDex注意事项

如果使用了MultiDex，建议通过Gradle的“`multiDexKeepFile`”配置等方式把Bugly的类放到主Dex，另外建议在`Application`类的"`attachBaseContext`"方法中主动加载非主dex：

```java
public class MyApplication extends SomeOtherApplication {
  @Override
  protected void attachBaseContext(Context base) {
     super.attachBaseContext(context);
     Multidex.install(this);
  }
}
```

##### 将bugly放入主Dex

```groovy
//file  multidex-config.pro
-keep class com.tencent.bugly.** { *; }

//buildTypes {}
multiDexKeepProguard file('multidex-config.pro')
```

![image-20200907134642662](https://tva1.sinaimg.cn/large/007S8ZIlgy1gii1dx0exnj30q305paai.jpg)

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gii1efr9dhj30k302idfz.jpg" alt="image-20200907134714144" style="zoom:150%;" />

[如果对上述使用方式不是很熟悉，MultiDex-Android dev相关文档](https://developer.android.com/studio/build/multidex?hl=zh-cn)

### 配置符号表

为了在调试时拿到更多异常信息，以及看到相关log,可以配置符号表。对于符号表，我们可以使用bugly插件自动配置。

[文档地址](https://bugly.qq.com/docs/user-guide/symbol-configuration-android/)

#### 添加依赖

在项目的buid.gradle文件的dependencies（buildscript部分）中添加：

```groovy
classpath 'com.tencent.bugly:symtabfileuploader:latest.release'
```

#### 添加插件和配置

在module的buid.gradle文件的顶部添加：

```groovy
apply plugin: 'bugly'

bugly {
    appId = '<APP_ID>' // 注册时分配的App ID
    appKey = '<APP_KEY>' // 注册时分配的App Key
}
```

> 其中APP_ID和APP_KEY是必填的，App ID和App key可以从“产品设置”里面获取。

#### 调试模式

调试模式默认是关闭的，使用时打开即可，调试模式打开后，在debug时也会自动上传符号表，否则只会在release下自动上传。

```groovy
bugly {
    debug = true
}
```



### 测试使用

```kotlin
CrashReport.testJavaCrash()
```

执行这段代码后，便可以在bugly控制台发现相应的异常信息。

